# FJSP_DRL_Custom

這個目錄包含了客製化版本的「彈性工廠排程深度強化學習 (FJSP_DRL)」模型。
此版本在原始模型的基礎上，新增了特徵並修改了獎勵函數，以更好地考慮機台負載平衡和減少機器切換，這對於後續的預防性維護聯合優化至關重要。

## 新增特徵

為了讓模型在排程決策時能考慮更多維度，我們在環境狀態中加入了以下特徵：

1.  **Raw Workload (原始總負載)**
    *   **類型：** 機台節點特徵
    *   **說明：** 表示每台機台當前已分配的總工作量（加工時間總和）。這有助於模型學習如何將工作均勻分配到各機台，實現負載平衡。

2.  **Predecessor Machine ID (前序工序的機台ID)**
    *   **類型：** 操作節點特徵
    *   **說明：** 表示當前工序在同一工件序列中，其前一個工序被分配到的機台 ID。這有助於模型判斷是否發生了機台切換，並學習減少不必要的切換，從而降低切換成本和潛在的維護需求。

3.  **Average Eligible Machine Load (可選機台的平均負載)**
    *   **類型：** 操作節點特徵
    *   **說明：** 表示所有可以執行當前工序的機台，其當前原始總負載的平均值。這為模型提供了一個更宏觀的視角，幫助它做出更有利於整體負載平衡的決策。

## 修改後的獎勵函數

原始 FJSP_DRL 模型主要優化完工時間 (Makespan)。為了納入負載平衡和機器切換的考量，我們將獎勵函數修改為多目標形式：

`Reward = - (w1 * Makespan + w2 * Workload_Imbalance_Penalty + w3 * Machine_Switching_Penalty)`

*   **Makespan (完工時間)：** 仍然是主要目標，模型會嘗試最小化它。
*   **Workload_Imbalance_Penalty (工作負載不平衡懲罰)：** 基於各機台原始總負載的方差計算。負載分佈越不均勻，懲罰越大。
*   **Machine_Switching_Penalty (機器切換懲罰)：** 對於每次機器切換（當前工序與前序工序在不同機台時）施加懲罰。

這些懲罰項會引導模型在優化完工時間的同時，也考慮到負載平衡和減少機器切換。

## 訓練模型

### 前提條件

*   確保您已安裝所有必要的 Python 套件（例如 PyTorch）。
*   確保您位於專案的根目錄下。

### 運行訓練腳本

請從專案的根目錄運行以下命令來啟動訓練：

```bash
python3 -m solution_methods.FJSP_DRL_Custom.train_FJSP_DRL
```

### 配置訓練參數

訓練參數可以在 `configs/FJSP_DRL_Custom.toml` 檔案中進行配置。您可以調整以下參數：

*   `[env_parameters]`：環境相關參數，例如 `num_jobs`、`num_mas`、`batch_size` 等。
*   `[model_parameters]`：模型架構相關參數，例如 `in_size_ma`、`in_size_ope` 等（這些已根據新增特徵進行更新）。
*   `[train_parameters]`：訓練過程相關參數，例如 `lr` (學習率)、`K_epochs` (更新次數)、`eps_clip` (PPO 裁剪係數) 等。

### 訓練輸出

*   訓練日誌將會顯示在終端機中。
*   訓練過程中，模型檢查點和日誌將會儲存到 `./saved_models/` 目錄下。

## 重要注意事項

*   **驗證功能：** 為了讓訓練能夠順利進行，目前 `train_FJSP_DRL.py` 中的驗證功能已被**禁用**。如果您需要啟用驗證，請參考原始程式碼並確保驗證數據集的路徑配置正確。
*   **`main.py` 中的 `DataLoader` 錯誤：** `joint_opt_fjssp_pm/main.py` 檔案中存在一個與 `DataLoader` 相關的 `TypeError`。這個錯誤與本訓練模組無關，但會阻止整個聯合優化流程的完整運行。在您需要運行 `main.py` 之前，需要單獨解決這個問題。
